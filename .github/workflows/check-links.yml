name: Check Links

on:
  schedule:
    # Run every Monday at 9:00 AM UTC (1:00 AM PST)
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    paths:
      - '**.md'
      - 'scripts/extract-urls.js'
      - 'scripts/check-links.js'
      - '.github/workflows/check-links.yml'

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Extract URLs from markdown files
        run: |
          node scripts/extract-urls.js scripts/urls.json

      - name: Check links
        id: check
        run: |
          echo "Running link checker..."

          # Run link checker and capture output
          if node scripts/check-links.js scripts/urls.json --output=github > link-report.md 2>check-errors.log; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "All links are working!"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Broken links found!"
          fi

          # Show stderr output (progress)
          cat check-errors.log

          # Save the report for the next step
          echo "EOF_MARKER_$(date +%s)" > /tmp/eof_marker
          EOF_MARKER=$(cat /tmp/eof_marker)
          echo "report<<$EOF_MARKER" >> $GITHUB_OUTPUT
          cat link-report.md >> $GITHUB_OUTPUT
          echo "$EOF_MARKER" >> $GITHUB_OUTPUT

      - name: Find existing issue
        id: find-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links,automated'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Broken Links Report')
            );

            if (existingIssue) {
              core.setOutput('issue-number', existingIssue.number);
              core.setOutput('found', 'true');
            } else {
              core.setOutput('found', 'false');
            }

      - name: Create or update issue for errors
        if: steps.check.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${{ steps.check.outputs.report }}`;
            const issueExists = '${{ steps.find-issue.outputs.found }}' === 'true';
            const issueNumber = '${{ steps.find-issue.outputs.issue-number }}';

            const issueBody = report + '\n\n---\n\n' +
              '**Next steps:**\n' +
              '1. Review each broken link\n' +
              '2. Update the markdown files with corrected URLs\n' +
              '3. For permanently moved content, update to the new URL\n' +
              '4. For removed content, remove the link or find an alternative\n' +
              '5. Re-run this workflow to verify fixes\n\n' +
              '*This issue will automatically update on the next scheduled check.*';

            if (issueExists) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: issueBody
              });

              // Add a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: `Updated broken links report on ${new Date().toISOString()}`
              });

              console.log(`Updated issue #${issueNumber}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”— Broken Links Report',
                body: issueBody,
                labels: ['broken-links', 'automated', 'maintenance']
              });

              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Close issue if all links working
        if: steps.check.outputs.status == 'success' && steps.find-issue.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.find-issue.outputs.issue-number }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: 'âœ… All links are now working! Closing this issue.'
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              state: 'closed'
            });

            console.log(`Closed issue #${issueNumber}`);

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-results
          path: |
            scripts/urls.json
            link-report.md
            check-errors.log
          retention-days: 30
